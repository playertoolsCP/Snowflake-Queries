--SET StartDate = '2025-05-08'; -- Will pull anything that was created from this date onwards
--SET UpToDate = '2025-05-21'; --Up to this date 
WITH LatestUpdates AS (
    SELECT 
        P.TOURNAMENTID,
        P.PRODUCTID,
        P._DELETED, 
        TO_TIMESTAMP(CAST(C.UPDATED AS NUMBER) / 1000000000) AS UPDATEDDATE,
        ROW_NUMBER() OVER (PARTITION BY P.TOURNAMENTID, P.PRODUCTID ORDER BY C.UPDATED DESC) AS RN
    FROM DERIVCO.CORE.VW_GGL_TOURNAMENT_PRODUCT_MAP P
    JOIN DERIVCO.CORE.VW_GGL_TOURNAMENT_CONFIG C
        ON P.TOURNAMENTID = C.TOURNAMENTID
),
DeletedProducts AS (
    SELECT 
        TOURNAMENTID,
        PRODUCTID
    FROM LatestUpdates
    WHERE RN = 1 AND _DELETED = TRUE -- Select the most recent updates marked as deleted
)
SELECT 
    C.TOURNAMENTID AS TournamentID,
    CS.CASINOID AS CasinoID,
    CS.CASINONAME AS CasinoName,
    CS.OPERATORREPORTINGNAME AS Operator
FROM DERIVCO.CORE.VW_GGL_TOURNAMENT_CONFIG C
JOIN DERIVCO.CORE.VW_GGL_TOURNAMENT_PRODUCT_MAP P
    ON C.TOURNAMENTID = P.TOURNAMENTID
INNER JOIN MASTERDIM.COMMERCIAL.VW_DIM_CASINO CS 
    ON CS.CasinoID = P.PRODUCTID
WHERE NOT EXISTS (
    SELECT 1
    FROM DeletedProducts D
    WHERE D.PRODUCTID = P.PRODUCTID
      AND D.TOURNAMENTID = P.TOURNAMENTID
)
AND CS.ROWISCURRENT = 1 -- This is what Pyramid is doing
--AND TO_TIMESTAMP(C.CREATED / 1000000000) < $StartDate 
--AND TO_TIMESTAMP(C.CREATED / 1000000000) <= $UpToDate
--AND C.TOURNAMENTID = 14872
AND C.NAME NOT LIKE 'GGL -%'
GROUP BY C.TOURNAMENTID, CS.CasinoID, CS.CasinoName, CS.OperatorReportingName;
